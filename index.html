<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N8N Customer Review Automation - Complete Guide</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.15"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        
        .header h1 {
            font-size: 3.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .header p {
            font-size: 1.3em;
            opacity: 0.9;
            position: relative;
        }
        
        .nav {
            background: #2c3e50;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-list {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 30px;
            list-style: none;
            padding: 0 20px;
        }
        
        .nav-list a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
        }
        
        .nav-list a:hover {
            background: #3498db;
            transform: translateY(-2px);
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 60px;
            opacity: 0;
            animation: fadeInUp 0.8s ease forwards;
        }
        
        .section:nth-child(even) {
            animation-delay: 0.2s;
        }
        
        .section:nth-child(odd) {
            animation-delay: 0.4s;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section h2 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 30px;
            position: relative;
            padding-bottom: 15px;
        }
        
        .section h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }
        
        .workflow-diagram {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 40px;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            margin: 30px 0;
            position: relative;
        }
        
        .step-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .step-content {
            flex: 1;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .step-content h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.4em;
        }
        
        .step-content p {
            color: #666;
            margin-bottom: 15px;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }
        
        .code-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: transform 0.6s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }
        
        .feature-card:hover::before {
            transform: rotate(45deg) translate(20px, 20px);
        }
        
        .feature-icon {
            font-size: 3em;
            margin-bottom: 20px;
            position: relative;
        }
        
        .feature-card h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
            position: relative;
        }
        
        .feature-card p {
            opacity: 0.9;
            position: relative;
        }
        
        .analytics-preview {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }
        
        .metric-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .setup-steps {
            counter-reset: step-counter;
        }
        
        .setup-step {
            counter-increment: step-counter;
            background: white;
            margin: 20px 0;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            position: relative;
            border-left: 4px solid #667eea;
        }
        
        .setup-step::before {
            content: counter(step-counter);
            position: absolute;
            left: -15px;
            top: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .setup-step h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            margin-left: 20px;
        }
        
        .setup-step p, .setup-step ul {
            margin-left: 20px;
            color: #666;
        }
        
        .setup-step ul {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .setup-step li {
            margin: 5px 0;
        }
        
        .table-structure {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .table-structure table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        
        .table-structure th,
        .table-structure td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table-structure th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        
        .table-structure tr:hover {
            background: #f8f9fa;
        }
        
        .cta-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 60px 40px;
            text-align: center;
            margin-top: 60px;
            position: relative;
            overflow: hidden;
        }
        
        .cta-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
        }
        
        .cta-button {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 15px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            margin: 20px 10px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .scrollTop {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        
        .scrollTop.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .scrollTop:hover {
            transform: translateY(-5px);
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5em;
            }
            
            .content {
                padding: 20px;
            }
            
            .workflow-step {
                flex-direction: column;
                text-align: center;
            }
            
            .step-icon {
                margin-right: 0;
                margin-bottom: 20px;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-list {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🚀 N8N Customer Review Automation</h1>
            <p>Complete Visual Guide & Implementation Manual</p>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <ul class="nav-list">
                <li><a href="#overview">📊 Overview</a></li>
                <li><a href="#workflow">🔄 Workflow</a></li>
                <li><a href="#features">✨ Features</a></li>
                <li><a href="#analytics">📈 Analytics</a></li>
                <li><a href="#setup">⚙️ Setup</a></li>
                <li><a href="#sheets">📋 Sheets</a></li>
            </ul>
        </nav>

        <div class="content">
            <!-- Overview Section -->
            <section id="overview" class="section">
                <h2>📊 System Overview</h2>
                <p>This N8N workflow automates the entire customer review process - from identifying eligible customers to generating comprehensive monthly analytics reports. Everything runs in a single, unified workflow.</p>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon">📧</div>
                        <h3>Automated Outreach</h3>
                        <p>Sends personalized WhatsApp messages and HTML emails to customers 7-30 days after purchase</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📊</div>
                        <h3>Smart Analytics</h3>
                        <p>Generates beautiful monthly reports with insights, charts, and actionable recommendations</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🔄</div>
                        <h3>Real-time Tracking</h3>
                        <p>Tracks review responses and updates customer status automatically via webhooks</p>
                    </div>
                </div>
            </section>

            <!-- Workflow Diagram -->
            <section id="workflow" class="section">
                <h2>🔄 Unified Workflow Structure</h2>
                
                <div class="workflow-diagram">
                    <div class="workflow-step">
                        <div class="step-icon">⏰</div>
                        <div class="step-content">
                            <h3>Schedule Trigger</h3>
                            <p><strong>Daily 10:00 AM:</strong> Review requests processing</p>
                            <p><strong>Monthly 1st 9:00 AM:</strong> Analytics generation</p>
                            <p><strong>Webhook:</strong> Real-time review logging</p>
                        </div>
                    </div>

                    <div class="workflow-step">
                        <div class="step-icon">🔀</div>
                        <div class="step-content">
                            <h3>Smart Router (Switch Node)</h3>
                            <p>Intelligently routes execution to the appropriate branch:</p>
                            <ul>
                                <li><strong>Branch A:</strong> Daily review requests</li>
                                <li><strong>Branch B:</strong> Monthly analytics</li>
                                <li><strong>Branch C:</strong> Webhook processing</li>
                            </ul>
                        </div>
                    </div>

                    <div class="workflow-step">
                        <div class="step-icon">📋</div>
                        <div class="step-content">
                            <h3>Data Processing</h3>
                            <p>Reads customer data from Google Sheets, filters eligible customers, and processes review responses with intelligent matching algorithms.</p>
                        </div>
                    </div>

                    <div class="workflow-step">
                        <div class="step-icon">📱</div>
                        <div class="step-content">
                            <h3>Multi-Channel Communication</h3>
                            <p>Sends beautifully formatted messages via:</p>
                            <ul>
                                <li><strong>WhatsApp Business API:</strong> Instant mobile reach</li>
                                <li><strong>Email (Gmail/SMTP):</strong> Professional HTML templates</li>
                            </ul>
                        </div>
                    </div>

                    <div class="workflow-step">
                        <div class="step-icon">📊</div>
                        <div class="step-content">
                            <h3>Analytics & Reporting</h3>
                            <p>Generates comprehensive reports with visual charts, sentiment analysis, and actionable insights delivered automatically to management.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Features Section -->
            <section id="features" class="section">
                <h2>✨ Key Features</h2>
                
                <div class="workflow-diagram">
                    <h3>🎯 Smart Customer Targeting</h3>
                    <div class="code-block">
// Intelligent customer filtering
const eligibleCustomers = customers.filter(customer => {
    const daysSincePurchase = calculateDays(customer.lastPurchase);
    const daysSinceLastRequest = calculateDays(customer.lastRequest);
    
    return daysSincePurchase >= 7 && 
           daysSincePurchase <= 30 && 
           daysSinceLastRequest > 30;
});
                    </div>

                    <h3>📱 Beautiful Message Templates</h3>
                    <div class="code-block">
🌟 WhatsApp Template:
Hi {{ customer.name }}! 👋
Thank you for choosing our service. We hope you loved your recent purchase!
⭐ Could you spare 2 minutes to leave us a Google review?
{{ reviewURL }}
                    </div>

                    <h3>📊 Advanced Analytics Engine</h3>
                    <div class="code-block">
📈 Calculates:
• Total reviews & average rating
• Response rates & conversion metrics  
• Sentiment analysis & rating distribution
• Monthly trends & actionable insights
• Beautiful HTML reports with charts
                    </div>
                </div>
            </section>

            <!-- Analytics Preview -->
            <section id="analytics" class="section">
                <h2>📈 Analytics Dashboard Preview</h2>
                
                <div class="analytics-preview">
                    <h3 style="text-align: center; margin-bottom: 30px;">Monthly Review Analytics - December 2024</h3>
                    
                    <div class="metric-cards">
                        <div class="metric-card">
                            <div class="metric-value">127</div>
                            <div class="metric-label">Total Reviews</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">4.6</div>
                            <div class="metric-label">Average Rating</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">18%</div>
                            <div class="metric-label">Response Rate</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">89%</div>
                            <div class="metric-label">Satisfaction</div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h4>📊 Rating Distribution</h4>
                        <div style="margin: 20px 0;">
                            <div style="display: flex; align-items: center; margin: 8px 0;">
                                <span style="width: 60px;">5 ⭐</span>
                                <div style="background: #e0e0e0; width: 200px; height: 20px; border-radius: 10px; margin: 0 10px;">
                                    <div style="background: #4caf50; width: 75%; height: 100%; border-radius: 10px;"></div>
                                </div>
                                <span>89 reviews</span>
                            </div>
                            <div style="display: flex; align-items: center; margin: 8px 0;">
                                <span style="width: 60px;">4 ⭐</span>
                                <div style="background: #e0e0e0; width: 200px; height: 20px; border-radius: 10px; margin: 0 10px;">
                                    <div style="background: #4caf50; width: 45%; height: 100%; border-radius: 10px;"></div>
                                </div>
                                <span>24 reviews</span>
                            </div>
                            <div style="display: flex; align-items: center; margin: 8px 0;">
                                <span style="width: 60px;">3 ⭐</span>
                                <div style="background: #e0e0e0; width: 200px; height: 20px; border-radius: 10px; margin: 0 10px;">
                                    <div style="background: #ff9800; width: 15%; height: 100%; border-radius: 10px;"></div>
                                </div>
                                <span>8 reviews</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Setup Instructions -->
            <section id="setup" class="section">
                <h2>⚙️ Complete Setup Guide</h2>
                
                <div class="setup-steps">
                    <div class="setup-step">
                        <h3>Create Google Sheets Database</h3>
                        <p>Set up your customer database with the required structure</p>
                        <ul>
                            <li>Create a new Google Spreadsheet</li>
                            <li>Add 3 sheets: "Customers", "Reviews", "Monthly Analytics"</li>
                            <li>Copy the spreadsheet ID from the URL</li>
                        </ul>
                    </div>

                    <div class="setup-step">
                        <h3>Configure API Credentials</h3>
                        <p>Set up all required API access</p>
                        <ul>
                            <li><strong>Google Sheets API:</strong> Enable in Google Cloud Console</li>
                            <li><strong>WhatsApp Business API:</strong> Get access token from Meta</li>
                            <li><strong>Gmail API:</strong> Configure OAuth or App Password</li>
                        </ul>
                    </div>

                    <div class="setup-step">
                        <h3>Environment Variables</h3>
                        <p>Configure these in your N8N instance:</p>
                        <div class="code-block">
GOOGLE_SHEETS_ID=your_spreadsheet_id
GOOGLE_REVIEW_URL=your_google_business_profile_review_url  
BUSINESS_NAME=Your Business Name
WHATSAPP_ACCESS_TOKEN=your_whatsapp_token
MANAGEMENT_EMAIL=management@domain.com
                        </div>
                    </div>

                    <div class="setup-step">
                        <h3>Import N8N Workflow</h3>
                        <p>Copy the workflow JSON and import into N8N</p>
                        <ul>
                            <li>Copy the complete workflow configuration</li>
                            <li>Import into your N8N instance</li>
                            <li>Configure all node credentials</li>
                            <li>Test each branch separately</li>
                        </ul>
                    </div>

                    <div class="setup-step">
                        <h3>Test & Deploy</h3>
                        <p>Validate everything works before going live</p>
                        <ul>
                            <li>Test with sample customer data</li>
                            <li>Verify message delivery</li>
                            <li>Check analytics generation</li>
                            <li>Enable scheduled triggers</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Google Sheets Structure -->
            <section id="sheets" class="section">
                <h2>📋 Google Sheets Structure</h2>
                
                <h3>Sheet 1: "Customers"</h3>
                <div class="table-structure">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Last Purchase Date</th>
                                <th>Review Requested</th>
                                <th>Request Date</th>
                                <th>Review Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>John Smith</td>
                                <td>john@example.com</td>
                                <td>+1234567890</td>
                                <td>2024-12-15</td>
                                <td>Yes</td>
                                <td>2024-12-22</td>
                                <td>Pending</td>
                            </tr>
                            <tr>
                                <td>Sarah Johnson</td>
                                <td>sarah@example.com</td>
                                <td>+1234567891</td>
                                <td>2024-12-10</td>
                                <td>No</td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3>Sheet 2: "Reviews"</h3>
                <div class="table-structure">
                    <table>
                        <thead>
                            <tr>
                                <th>Reviewer Name</th>
                                <th>Rating</th>
                                <th>Review Text</th>
                                <th>Review Date</th>
                                <th>Review ID</th>
                                <th>Source</th>
                                <th>Customer Matched</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>John Smith</td>
                                <td>5</td>
                                <td>Excellent service!</td>
                                <td>2024-12-25</td>
                                <td>rev_001</td>
                                <td>Google</td>
                                <td>Yes</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3>Sheet 3: "Monthly Analytics"</h3>
                <div class="table-structure">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Year</th>
                                <th>Total Reviews</th>
                                <th>Average Rating</th>
                                <th>Response Rate</th>
                                <th>Positive %</th>
                                <th>Negative %</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>December</td>
                                <td>2024</td>
                                <td>127</td>
                                <td>4.6</td>
                                <td>18%</td>
                                <td>89%</td>
                                <td>4%</td>
                                <td>Great month!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Code Examples Section -->
            <section id="code" class="section">
                <h2>💻 Implementation Code Examples</h2>
                
                <h3>🎯 Customer Filtering Logic</h3>
                <div class="code-block">
// Smart customer eligibility filter
const today = new Date();
const eligibleCustomers = [];

for (const customer of $input.all()) {
    const lastPurchaseDate = new Date(customer.json['Last Purchase Date']);
    const lastRequestDate = customer.json['Request Date'] ? 
        new Date(customer.json['Request Date']) : null;
    
    const daysSincePurchase = Math.floor((today - lastPurchaseDate) / (1000 * 60 * 60 * 24));
    const daysSinceLastRequest = lastRequestDate ? 
        Math.floor((today - lastRequestDate) / (1000 * 60 * 60 * 24)) : 999;
    
    // Perfect timing: 7-30 days after purchase, not contacted recently
    if (daysSincePurchase >= 7 && daysSincePurchase <= 30 && 
        daysSinceLastRequest > 30) {
        eligibleCustomers.push({
            name: customer.json['Name'],
            email: customer.json['Email'],
            phone: customer.json['Phone'],
            lastPurchase: customer.json['Last Purchase Date'],
            operation: 'send_review_request'
        });
    }
}

return eligibleCustomers.map(customer => ({ json: customer }));
                </div>

                <h3>📊 Analytics Calculation Engine</h3>
                <div class="code-block">
// Comprehensive monthly analytics calculator
const reviews = $input.all();
const now = new Date();
const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

// Filter last month's reviews
const monthlyReviews = reviews.filter(review => {
    const reviewDate = new Date(review.json['Review Date']);
    return reviewDate >= lastMonth && reviewDate < currentMonth;
});

// Calculate key metrics
const totalReviews = monthlyReviews.length;
const averageRating = totalReviews > 0 ? 
    monthlyReviews.reduce((sum, review) => sum + parseFloat(review.json.Rating), 0) / totalReviews : 0;

// Rating distribution analysis
const ratingDistribution = {
    5: monthlyReviews.filter(r => parseFloat(r.json.Rating) === 5).length,
    4: monthlyReviews.filter(r => parseFloat(r.json.Rating) === 4).length,
    3: monthlyReviews.filter(r => parseFloat(r.json.Rating) === 3).length,
    2: monthlyReviews.filter(r => parseFloat(r.json.Rating) === 2).length,
    1: monthlyReviews.filter(r => parseFloat(r.json.Rating) === 1).length
};

// Sentiment analysis
const positiveReviews = monthlyReviews.filter(r => parseFloat(r.json.Rating) >= 4).length;
const neutralReviews = monthlyReviews.filter(r => parseFloat(r.json.Rating) === 3).length;
const negativeReviews = monthlyReviews.filter(r => parseFloat(r.json.Rating) <= 2).length;

// Generate actionable insights
let insights = [];
if (averageRating >= 4.5) insights.push("🎉 Excellent customer satisfaction!");
if (negativeReviews > totalReviews * 0.2) insights.push("⚠️ High negative feedback - investigate");
if (responseRate < 10) insights.push("📈 Optimize review request strategy");

return [{ json: { totalReviews, averageRating, ratingDistribution, insights } }];
                </div>

                <h3>📱 WhatsApp Message Template</h3>
                <div class="code-block">
// Dynamic WhatsApp message with personalization
const message = `Hi ${customerName}! 👋

Thank you for choosing our service. We hope you loved your recent purchase on ${lastPurchaseDate}.

Your feedback helps us improve and helps other customers too! 

⭐ Could you spare 2 minutes to leave us a Google review?
${process.env.GOOGLE_REVIEW_URL}

Thank you so much! 🙏

Reply STOP to opt out.`;

// Send via WhatsApp Business API
return [{
    json: {
        phone: customerPhone,
        message: message,
        template_name: "review_request"
    }
}];
                </div>

                <h3>📧 Email HTML Template Generator</h3>
                <div class="code-block">
// Beautiful HTML email template
const generateEmailHTML = (customerName, lastPurchaseDate) => `
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;style&gt;
        body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 30px; text-align: center; 
        }
        .cta-button { 
            background: #4285f4; color: white; padding: 15px 30px; 
            text-decoration: none; border-radius: 25px; font-weight: bold; 
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;div class="header"&gt;
            &lt;h1&gt;Hi ${customerName}!&lt;/h1&gt;
            &lt;p&gt;Thank you for being an amazing customer 🎉&lt;/p&gt;
        &lt;/div&gt;
        &lt;div style="padding: 30px;"&gt;
            &lt;p&gt;We hope you're absolutely loving your recent purchase from ${lastPurchaseDate}!&lt;/p&gt;
            &lt;div style="text-align: center; margin: 30px 0;"&gt;
                &lt;a href="${process.env.GOOGLE_REVIEW_URL}" class="cta-button"&gt;
                    🌟 Leave a Google Review
                &lt;/a&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;`;
                </div>
            </section>

            <!-- Workflow Configuration -->
            <section id="workflow-config" class="section">
                <h2>🔧 N8N Workflow Configuration</h2>
                
                <div class="workflow-diagram">
                    <h3>📋 Required N8N Nodes</h3>
                    <div class="setup-steps">
                        <div class="setup-step">
                            <h3>Schedule Trigger Node</h3>
                            <ul>
                                <li><strong>Cron Expression:</strong> <code>0 10 * * *</code> (Daily at 10 AM)</li>
                                <li><strong>Monthly Trigger:</strong> <code>0 9 1 * *</code> (1st of month at 9 AM)</li>
                                <li><strong>Timezone:</strong> Your local timezone</li>
                            </ul>
                        </div>

                        <div class="setup-step">
                            <h3>Switch Node Configuration</h3>
                            <ul>
                                <li><strong>Route 1:</strong> <code>{{ DateTime.now().day === 1 && DateTime.now().hour === 9 }}</code></li>
                                <li><strong>Route 2:</strong> <code>{{ DateTime.now().hour === 10 }}</code></li>
                                <li><strong>Route 3:</strong> Webhook processing (always active)</li>
                            </ul>
                        </div>

                        <div class="setup-step">
                            <h3>Google Sheets Nodes</h3>
                            <ul>
                                <li><strong>Operation:</strong> Read/Update/Append</li>
                                <li><strong>Authentication:</strong> Service Account or OAuth2</li>
                                <li><strong>Range:</strong> Dynamic based on data structure</li>
                            </ul>
                        </div>

                        <div class="setup-step">
                            <h3>WhatsApp Business Node</h3>
                            <ul>
                                <li><strong>API Version:</strong> Cloud API v17.0</li>
                                <li><strong>Authentication:</strong> Access Token</li>
                                <li><strong>Message Type:</strong> Template or Freeform</li>
                            </ul>
                        </div>

                        <div class="setup-step">
                            <h3>Email/Gmail Node</h3>
                            <ul>
                                <li><strong>Authentication:</strong> OAuth2 or App Password</li>
                                <li><strong>Format:</strong> HTML with embedded CSS</li>
                                <li><strong>Attachments:</strong> Optional analytics reports</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Troubleshooting Guide -->
            <section id="troubleshooting" class="section">
                <h2>🔧 Troubleshooting Guide</h2>
                
                <div class="workflow-diagram">
                    <h3>❗ Common Issues & Solutions</h3>
                    
                    <div class="setup-steps">
                        <div class="setup-step">
                            <h3>Google Sheets API Errors</h3>
                            <p><strong>Issue:</strong> "Permission denied" or "Sheets not found"</p>
                            <ul>
                                <li>Verify Service Account has access to the spreadsheet</li>
                                <li>Check if spreadsheet ID is correct</li>
                                <li>Ensure API is enabled in Google Cloud Console</li>
                                <li>Share spreadsheet with service account email</li>
                            </ul>
                        </div>

                        <div class="setup-step">
                            <h3>WhatsApp Message Delivery Issues</h3>
                            <p><strong>Issue:</strong> Messages not being sent or delivered</p>
                            <ul>
                                <li>Verify WhatsApp Business API token is valid</li>
                                <li>Check phone number format (include country code)</li>
                                <li>Ensure business verification is complete</li>
                                <li>Test with template messages first</li>
                            </ul>
                        </div>

                        <div class="setup-step">
                            <h3>Email Delivery Problems</h3>
                            <p><strong>Issue:</strong> Emails going to spam or not sending</p>
                            <ul>
                                <li>Use authenticated SMTP or Gmail API</li>
                                <li>Add proper SPF/DKIM records to your domain</li>
                                <li>Include unsubscribe links in emails</li>
                                <li>Test with personal email first</li>
                            </ul>
                        </div>

                        <div class="setup-step">
                            <h3>Schedule Trigger Not Working</h3>
                            <p><strong>Issue:</strong> Workflow not running at scheduled times</p>
                            <ul>
                                <li>Check N8N instance timezone settings</li>
                                <li>Verify cron expression syntax</li>
                                <li>Ensure workflow is active (not paused)</li>
                                <li>Check N8N execution logs for errors</li>
                            </ul>
                        </div>

                        <div class="setup-step">
                            <h3>Data Processing Errors</h3>
                            <p><strong>Issue:</strong> Customer filtering or analytics calculation fails</p>
                            <ul>
                                <li>Verify date formats in Google Sheets</li>
                                <li>Check for empty cells or null values</li>
                                <li>Validate data types (numbers vs strings)</li>
                                <li>Add error handling in Code nodes</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Best Practices -->
            <section id="best-practices" class="section">
                <h2>🎯 Best Practices & Optimization</h2>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon">⏰</div>
                        <h3>Timing Strategy</h3>
                        <p>Send requests 7-14 days after purchase for highest response rates. Avoid weekends and holidays.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">✉️</div>
                        <h3>Message Optimization</h3>
                        <p>Keep messages personal, brief, and include clear value proposition. A/B test different templates.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">📊</div>
                        <h3>Analytics Focus</h3>
                        <p>Track response rates, sentiment trends, and ROI. Use insights to continuously improve the process.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">🔄</div>
                        <h3>Follow-up Strategy</h3>
                        <p>Send gentle reminders after 7 days. Stop after 2 attempts to avoid being perceived as spam.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">🛡️</div>
                        <h3>Compliance</h3>
                        <p>Always include unsubscribe options. Follow GDPR, CAN-SPAM, and local regulations.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">🎯</div>
                        <h3>Segmentation</h3>
                        <p>Customize messages based on purchase value, product category, or customer history.</p>
                    </div>
                </div>
                
                <h3>💡 Pro Tips for Higher Response Rates</h3>
                <div class="workflow-diagram">
                    <div class="code-block">
✅ DO:
• Personalize with customer name and purchase details
• Include direct link to your Google Business Profile
• Send from a recognizable business email/number
• Use emojis sparingly but effectively
• Make it mobile-friendly (most customers use mobile)
• Include social proof ("Join 500+ happy customers")

❌ DON'T:
• Send generic, impersonal messages
• Be pushy or demanding
• Send too frequently (max 2 requests per customer)
• Use all caps or excessive punctuation
• Make the process complicated
• Ignore negative feedback or reviews
                    </div>
                </div>
            </section>

            <!-- Advanced Features -->
            <section id="advanced" class="section">
                <h2>🚀 Advanced Features & Customizations</h2>
                
                <h3>🤖 AI-Powered Enhancements</h3>
                <div class="setup-steps">
                    <div class="setup-step">
                        <h3>Sentiment Analysis Integration</h3>
                        <p>Add OpenAI or Google Cloud Natural Language API to automatically analyze review sentiment and identify key themes.</p>
                        <div class="code-block">
// AI Sentiment Analysis
const sentiment = await openai.analyze(reviewText);
const insights = {
    sentiment: sentiment.score, // -1 to 1
    keywords: sentiment.keywords,
    emotions: sentiment.emotions,
    actionRequired: sentiment.score < -0.3
};
                        </div>
                    </div>

                    <div class="setup-step">
                        <h3>Smart Response Automation</h3>
                        <p>Automatically respond to negative reviews with appropriate, personalized messages.</p>
                        <div class="code-block">
// Auto-response for negative reviews
if (rating <= 2) {
    const response = `Thank you for your feedback, ${reviewerName}. 
    We take all concerns seriously and would love to make this right. 
    Please contact us at support@business.com so we can resolve this promptly.`;
    
    // Post response to Google My Business
    await postReviewResponse(reviewId, response);
}
                        </div>
                    </div>
                </div>

                <h3>📊 Advanced Analytics</h3>
                <div class="setup-steps">
                    <div class="setup-step">
                        <h3>Predictive Analytics</h3>
                        <p>Predict which customers are most likely to leave reviews based on purchase history and behavior.</p>
                    </div>

                    <div class="setup-step">
                        <h3>Competitor Benchmarking</h3>
                        <p>Track competitor ratings and compare against your own performance metrics.</p>
                    </div>

                    <div class="setup-step">
                        <h3>Revenue Impact Analysis</h3>
                        <p>Calculate the ROI of reviews on sales, conversion rates, and customer acquisition.</p>
                    </div>
                </div>

                <h3>🔗 Additional Integrations</h3>
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon">💬</div>
                        <h3>Slack Notifications</h3>
                        <p>Real-time alerts for new reviews, especially negative ones requiring immediate attention.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">📱</div>
                        <h3>SMS Integration</h3>
                        <p>Add SMS as a third communication channel using Twilio for maximum reach.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">📈</div>
                        <h3>CRM Integration</h3>
                        <p>Sync review data with Salesforce, HubSpot, or other CRM systems.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">🎯</div>
                        <h3>Marketing Automation</h3>
                        <p>Integrate with Mailchimp, ActiveCampaign for advanced email sequences.</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Call to Action -->
        <div class="cta-section">
            <h2>🚀 Ready to Transform Your Review Strategy?</h2>
            <p>Implement this powerful N8N automation system and watch your online reputation soar!</p>
            <a href="#setup" class="cta-button">📋 Start Setup Guide</a>
            <a href="#workflow" class="cta-button">🔄 View Workflow</a>
            <a href="#sheets" class="cta-button">📊 Setup Sheets</a>
            
            <div style="margin-top: 40px; position: relative;">
                <h3>🎯 Expected Results Within 30 Days:</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;">3x</div>
                        <div>More Reviews</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;">15-25%</div>
                        <div>Response Rate</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;">4.5+</div>
                        <div>Average Rating</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;">80%</div>
                        <div>Time Saved</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <a href="#" class="scrollTop" id="scrollTop">↑</a>

    <script>
        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Show/hide scroll to top button
        window.addEventListener('scroll', function() {
            const scrollTop = document.getElementById('scrollTop');
            if (window.pageYOffset > 300) {
                scrollTop.classList.add('visible');
            } else {
                scrollTop.classList.remove('visible');
            }
        });

        // Add animation on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        document.querySelectorAll('.section').forEach(section => {
            observer.observe(section);
        });

        // Copy code functionality for code blocks
        document.querySelectorAll('.code-block').forEach(codeBlock => {
            const copyButton = document.createElement('button');
            copyButton.textContent = '📋 Copy';
            copyButton.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(255,255,255,0.1);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.8em;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            codeBlock.style.position = 'relative';
            codeBlock.appendChild(copyButton);
            
            codeBlock.addEventListener('mouseenter', () => {
                copyButton.style.opacity = '1';
            });
            
            codeBlock.addEventListener('mouseleave', () => {
                copyButton.style.opacity = '0';
            });
            
            copyButton.addEventListener('click', () => {
                const text = codeBlock.textContent.replace('📋 Copy', '').trim();
                navigator.clipboard.writeText(text).then(() => {
                    copyButton.textContent = '✅ Copied!';
                    setTimeout(() => {
                        copyButton.textContent = '📋 Copy';
                    }, 2000);
                });
            });
        });

        // Interactive analytics demo
        function updateAnalyticsDemo() {
            const metrics = document.querySelectorAll('.metric-value');
            metrics.forEach(metric => {
                const currentValue = parseInt(metric.textContent);
                if (!isNaN(currentValue)) {
                    let startValue = 0;
                    const increment = currentValue / 50;
                    const timer = setInterval(() => {
                        startValue += increment;
                        if (startValue >= currentValue) {
                            metric.textContent = currentValue;
                            clearInterval(timer);
                        } else {
                            metric.textContent = Math.floor(startValue);
                        }
                    }, 20);
                }
            });
        }

        // Trigger animation when analytics section comes into view
        const analyticsObserver = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    updateAnalyticsDemo();
                    analyticsObserver.unobserve(entry.target);
                }
            });
        });

        const analyticsSection = document.getElementById('analytics');
        if (analyticsSection) {
            analyticsObserver.observe(analyticsSection);
        }
    </script>
</body>
</html>